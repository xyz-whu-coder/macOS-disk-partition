# GPT Partition

《软件安全》有个实验是要获取磁盘分区的信息（GPT头和分区表），但祖传代码什么的大多都是Windows环境的代码。为了在macOS本机跑通，遂复现了[网上](https://www.cnblogs.com/libra13179/p/13537973.html)的代码。

但水平有限，基本只在计算分区大小等输出形式方面做了变动……


## 介绍

运行结果（是的，就是 256GB 丐中丐）：

```dotnetcli
逻辑块大小: 4096 bytes

MBR:
引导程序:
00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 
00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 
00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 
00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 
00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 
00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 
00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 
00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 
00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 
00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 
00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 
00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 
00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 
00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 
00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 
00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 
00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 
00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 
00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 
00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 
00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 
00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 
00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 
00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 
00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 
00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 
00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 
00 00 00 00 00 00 00 00   
磁盘签名            =   0x00000000  
未知                =   0x0000
活动状态            =   0x00
开始磁头            =   0xFE
开始扇区和柱面      =   0xFFFF
分区类型            =   0xEE
结束磁头            =   0xFE
结束扇区和柱面      =   0xFFFF
这个分区前的扇区数  =   0x00000001
这个分区的扇区数    =   0x03A70C6F
结束标志            =   0xAA55

GPT:
签名                    =   EFI PART
版本号                  =   0x00010000
GPT表头大小             =   92
CRC-32校验              =   0x059570E5
表头扇区号              =   0x00000001
备份表头扇区号          =   0x03A70C6F
GPT分区起始扇区号       =   0x00000006
GPT分区结束扇区号       =   0x03A70C6A
磁盘GUID                =   A0BA6CB7-00CA-492E-BAE8-4DE05AC3470B
分区表起始扇区号        =   0x00000002
分区表总项数            =   0x80
单个分区表占用字节数    =   0x80
分区表的CRC校验         =   0x7C06E440
硬盘总大小              =   251000193024 Bytes / 251000.193024 MB / 251.000193 GB

第 1 个分区表:
标明分区类型的GUID  =   69646961-6700-11AA-AA11-00306543ECAC
分区特有的GUID      =   D1674E14-7D07-4C22-AC4F-C41E9DFD3ACA
该分区起始扇区号    =   0x00000006
该分区起始扇区号    =   0x0001F405
分区的属性标志      =   0x00000000
该分区名            =   iBootSystemContainer
该分区大小          =   524288000 Bytes / 524.288000 MB / 0.524288 GB

第 2 个分区表:
标明分区类型的GUID  =   7C3457EF-0000-11AA-AA11-00306543ECAC
分区特有的GUID      =   3BD65449-F16E-40C8-B9CE-43653D4B5FC2
该分区起始扇区号    =   0x0001F406
该分区起始扇区号    =   0x03930C75
分区的属性标志      =   0x00000000
该分区名            =   Container
该分区大小          =   245107195904 Bytes / 245107.195904 MB / 245.107196 GB

第 3 个分区表:
标明分区类型的GUID  =   52637672-7900-11AA-AA11-00306543ECAC
分区特有的GUID      =   8C0EE2AF-7B12-498A-92CD-B45FFC329B84
该分区起始扇区号    =   0x03930C76
该分区起始扇区号    =   0x03A70C6A
分区的属性标志      =   0x00000000
该分区名            =   RecoveryOSContainer
该分区大小          =   5368664064 Bytes / 5368.664064 MB / 5.368664 GB
```

发现MBR在这里是无效的。

对照 `test/` 中的信息可以发现关键信息如GUID、大小都一致。但计算发现 `diskutil` 给出的分区大小都是以 1000 bytes = 1KB, 1000KB = 1MB, 1000MB = 1GB 来换算的，开始用1024就发现不对。

`disk` 参数暂时只能用 `/dev/disk0`，其他的要么 `Permission denied` 要么 `Can't open device: Resource busy`…… 不过在分区表里是已经有 `/dev/disk1`、`/dev/disk2`、`/dev/disk3` 的部分信息了，也能算出它们分别的大小。


## TODO

实现的细节好多都没看懂，对我来说简直是魔法（

macOS 里 `/dev/diskxxx` 究竟是怎么设计的（

